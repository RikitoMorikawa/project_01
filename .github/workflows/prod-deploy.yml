name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: "ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³"
        required: true
        default: "latest"
      rollback:
        description: "ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œï¼ˆtrue/falseï¼‰"
        required: false
        default: false
        type: boolean
      skip_tests:
        description: "ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆç·Šæ€¥æ™‚ã®ã¿ï¼‰"
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: ap-northeast-1
  ENVIRONMENT: prod
  PROJECT_NAME: csr-lambda-api

jobs:
  pre-deployment-check:
    name: ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest

    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      rollback-mode: ${{ steps.check.outputs.rollback-mode }}

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯
        id: check
        run: |
          echo "=== æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯ ==="
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ github.event.inputs.version }}"
          echo "ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯: ${{ github.event.inputs.rollback }}"
          echo "ãƒ†ã‚¹ãƒˆã‚¹ã‚­ãƒƒãƒ—: ${{ github.event.inputs.skip_tests }}"

          if [[ "${{ github.event.inputs.rollback }}" == "true" ]]; then
            echo "ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™"
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "rollback-mode=true" >> $GITHUB_OUTPUT
          else
            echo "é€šå¸¸ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™"
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "rollback-mode=false" >> $GITHUB_OUTPUT
          fi

  test:
    name: æœ¬ç•ªç’°å¢ƒç”¨å³æ ¼ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    needs: pre-deployment-check
    if: needs.pre-deployment-check.outputs.should-deploy == 'true' && needs.pre-deployment-check.outputs.rollback-mode == 'false' && github.event.inputs.skip_tests != 'true'

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Python ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Node.js ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          cd frontend
          npm ci --production=false

      - name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å³æ ¼ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: |
          cd backend
          # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
          if [ -d "tests" ] && [ "$(find tests -name '*.py' | wc -l)" -gt 0 ]; then
            # pytest-cov ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
            if python -c "import pytest_cov" 2>/dev/null; then
              python -m pytest tests/ -v --tb=short --cov=app --cov-report=xml --cov-fail-under=80
            else
              echo "pytest-cov ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚«ãƒãƒ¬ãƒƒã‚¸ãªã—ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚"
              python -m pytest tests/ -v --tb=short
            fi
          else
            echo "ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          fi

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å³æ ¼ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: |
          cd frontend
          # ãƒªãƒ³ãƒˆå®Ÿè¡Œï¼ˆå³æ ¼ï¼‰
          if npm run lint --silent 2>/dev/null; then
            npm run lint
          else
            echo "ãƒªãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          fi

          # å‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œï¼ˆå³æ ¼ï¼‰
          if npm run type-check --silent 2>/dev/null; then
            npm run type-check
          else
            echo "å‹ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          fi

          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ä»˜ãï¼‰
          if npm test --silent 2>/dev/null; then
            npm test -- --coverage --watchAll=false --coverageThreshold='{"global":{"branches":70,"functions":70,"lines":70,"statements":70}}'
          else
            echo "ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          fi

      - name: æœ¬ç•ªç’°å¢ƒç”¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ
        run: |
          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆå³æ ¼ï¼‰
          cd backend
          pip install safety bandit

          echo "=== Safety ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œï¼ˆå³æ ¼ï¼‰ ==="
          safety check --json

          echo "=== Bandit ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œï¼ˆå³æ ¼ï¼‰ ==="
          bandit -r app/ -f json

          cd ..

          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆå³æ ¼ï¼‰
          echo "=== npm audit å®Ÿè¡Œï¼ˆå³æ ¼ï¼‰ ==="
          cd frontend
          npm audit --audit-level=moderate
          cd ..

      - name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: |
          cd frontend
          # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
          cat > .env.production << EOF
          NEXT_PUBLIC_API_URL=https://test-api.example.com
          NEXT_PUBLIC_ENVIRONMENT=prod
          NEXT_PUBLIC_AWS_REGION=ap-northeast-1
          EOF

          # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æä»˜ãï¼‰
          npm run build

          # ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºåˆ†æ
          if npm run build -- --analyze --silent 2>/dev/null; then
            npm run build -- --analyze
          else
            echo "ãƒãƒ³ãƒ‰ãƒ«åˆ†æã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          fi

      - name: æœ¬ç•ªç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
        run: |
          # ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
          mkdir -p build/backend

          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼
          cp -r backend/app build/backend/
          cp backend/lambda_handler.py build/backend/
          cp backend/requirements.txt build/backend/

          # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœ¬ç•ªæœ€é©åŒ–ï¼‰
          cd build/backend
          pip install -r requirements.txt -t . --no-deps --compile
          pip install -r requirements.txt -t . --upgrade --compile

          # ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name "*.pyc" -delete 2>/dev/null || true
          find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name "*.so" -exec strip {} + 2>/dev/null || true
          find . -name "*.py" -exec python3 -m py_compile {} + 2>/dev/null || true

          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä½œæˆ
          zip -9 -r ../lambda-deployment-package.zip . -x "*.git*" "*.DS_Store*" "tests/*" "*.pytest_cache*" "*.coverage*" "*.md" "*.txt" "*.rst"

          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã®ç¢ºèªï¼ˆå³æ ¼ï¼‰
          PACKAGE_SIZE=$(stat -f%z ../lambda-deployment-package.zip 2>/dev/null || stat -c%s ../lambda-deployment-package.zip)
          echo "Lambda ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚µã‚¤ã‚º: $PACKAGE_SIZE bytes"

          # 50MBåˆ¶é™ã®ç¢ºèª
          if [ $PACKAGE_SIZE -gt 52428800 ]; then
            echo "ã‚¨ãƒ©ãƒ¼: Lambdaãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒ50MBã‚’è¶…ãˆã¦ã„ã¾ã™"
            exit 1
          fi

  deploy:
    name: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
    needs: [pre-deployment-check, test]
    runs-on: ubuntu-latest
    if: always() && needs.pre-deployment-check.outputs.should-deploy == 'true' && (needs.test.result == 'success' || needs.test.result == 'skipped' || needs.pre-deployment-check.outputs.rollback-mode == 'true')

    environment:
      name: production
      url: ${{ steps.deploy-info.outputs.frontend-url }}

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Python ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Node.js ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: AWS èªè¨¼æƒ…å ±ã‚’è¨­å®š
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: AWS èªè¨¼æƒ…å ±ã‚’ç¢ºèª
        run: |
          echo "AWSèªè¨¼æƒ…å ±ã‚’ç¢ºèªä¸­..."
          aws sts get-caller-identity
          export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "AWS_ACCOUNT_ID=$AWS_ACCOUNT_ID" >> $GITHUB_ENV
          echo "STACK_PREFIX=${PROJECT_NAME}-${ENVIRONMENT}" >> $GITHUB_ENV

      - name: å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y jq zip unzip bc

      - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
        if: needs.pre-deployment-check.outputs.rollback-mode == 'true'
        run: |
          echo "=== æœ¬ç•ªç’°å¢ƒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ ==="

          # Lambdaé–¢æ•°ã®å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™
          if aws lambda get-alias --function-name "${STACK_PREFIX}-api-function" --name "LIVE" --region "$AWS_REGION" >/dev/null 2>&1; then
            CURRENT_VERSION=$(aws lambda get-alias \
              --function-name "${STACK_PREFIX}-api-function" \
              --name "LIVE" \
              --region "$AWS_REGION" \
              --query 'FunctionVersion' \
              --output text)
            
            echo "ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $CURRENT_VERSION"
            
            # å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ï¼ˆç°¡å˜ãªä¾‹ã¨ã—ã¦-1ï¼‰
            if [ "$CURRENT_VERSION" != "1" ]; then
              PREVIOUS_VERSION=$((CURRENT_VERSION - 1))
              
              echo "å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¸­: $PREVIOUS_VERSION"
              aws lambda update-alias \
                --function-name "${STACK_PREFIX}-api-function" \
                --name "LIVE" \
                --function-version "$PREVIOUS_VERSION" \
                --region "$AWS_REGION"
              
              echo "âœ… Lambdaé–¢æ•°ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"
            else
              echo "ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯èƒ½ãªå‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“"
            fi
          fi

          echo "ğŸ”„ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"
          exit 0

      - name: ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
        if: needs.pre-deployment-check.outputs.rollback-mode == 'false'
        run: |
          echo "=== æœ¬ç•ªã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹ ==="
          cd infrastructure/prod
          chmod +x deploy.sh
          ./deploy.sh

      - name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰
        if: needs.pre-deployment-check.outputs.rollback-mode == 'false'
        run: |
          echo "=== æœ¬ç•ªãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰é–‹å§‹ ==="

          # ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
          mkdir -p build/backend

          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼
          cp -r backend/app build/backend/
          cp backend/lambda_handler.py build/backend/
          cp backend/requirements.txt build/backend/

          # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœ¬ç•ªæœ€é©åŒ–ï¼‰
          cd build/backend
          pip install --upgrade pip
          pip install -r requirements.txt -t . --no-deps --compile
          pip install -r requirements.txt -t . --upgrade --compile

          # ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name "*.pyc" -delete 2>/dev/null || true
          find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name "*.so" -exec strip {} + 2>/dev/null || true
          find . -name "*.py" -exec python3 -m py_compile {} + 2>/dev/null || true

          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä½œæˆï¼ˆæœ¬ç•ªæœ€é©åŒ–ï¼‰
          zip -9 -r ../lambda-deployment-package.zip . -x "*.git*" "*.DS_Store*" "tests/*" "*.pytest_cache*" "*.coverage*" "*.md" "*.txt" "*.rst"
          cd ../..

      - name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ–ãƒ«ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
        if: needs.pre-deployment-check.outputs.rollback-mode == 'false'
        run: |
          echo "=== æœ¬ç•ªãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹ï¼ˆãƒ–ãƒ«ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰ ==="

          # S3ãƒã‚±ãƒƒãƒˆã®è¨­å®š
          LAMBDA_BUCKET="${PROJECT_NAME}-${ENVIRONMENT}-lambda-deployments-${AWS_ACCOUNT_ID}"
          LAMBDA_KEY="lambda-deployment-package-$(date +%Y%m%d-%H%M%S).zip"

          # S3ãƒã‚±ãƒƒãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
          if ! aws s3 ls "s3://$LAMBDA_BUCKET" --region "$AWS_REGION" >/dev/null 2>&1; then
            echo "Lambda ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç”¨ S3 ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆä¸­: $LAMBDA_BUCKET"
            aws s3 mb "s3://$LAMBDA_BUCKET" --region "$AWS_REGION"
            aws s3api put-bucket-versioning --bucket "$LAMBDA_BUCKET" --versioning-configuration Status=Enabled --region "$AWS_REGION"
          fi

          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          echo "Lambdaãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ S3 ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."
          aws s3 cp "build/lambda-deployment-package.zip" "s3://$LAMBDA_BUCKET/$LAMBDA_KEY" --region "$AWS_REGION"

          # Lambdaé–¢æ•°ã®æ›´æ–°ï¼ˆãƒ–ãƒ«ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
          if aws lambda get-function --function-name "${STACK_PREFIX}-api-function" --region "$AWS_REGION" >/dev/null 2>&1; then
            echo "Lambdaé–¢æ•°ã‚’æ›´æ–°ä¸­..."
            
            # æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆ
            NEW_VERSION=$(aws lambda update-function-code \
              --function-name "${STACK_PREFIX}-api-function" \
              --s3-bucket "$LAMBDA_BUCKET" \
              --s3-key "$LAMBDA_KEY" \
              --region "$AWS_REGION" \
              --query 'Version' \
              --output text)
            
            # é–¢æ•°ã®æ›´æ–°å®Œäº†ã‚’å¾…æ©Ÿ
            aws lambda wait function-updated \
              --function-name "${STACK_PREFIX}-api-function" \
              --region "$AWS_REGION"
            
            echo "æ–°ã—ã„Lambdaãƒãƒ¼ã‚¸ãƒ§ãƒ³: $NEW_VERSION"
            
            # ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®æ›´æ–°ï¼ˆæ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
            if aws lambda get-alias --function-name "${STACK_PREFIX}-api-function" --name "LIVE" --region "$AWS_REGION" >/dev/null 2>&1; then
              # æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ10%ã‹ã‚‰é–‹å§‹ï¼‰
              echo "æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆ10%ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ï¼‰"
              aws lambda update-alias \
                --function-name "${STACK_PREFIX}-api-function" \
                --name "LIVE" \
                --function-version "$NEW_VERSION" \
                --routing-config "AdditionalVersionWeights={\"$NEW_VERSION\":0.1}" \
                --region "$AWS_REGION"
              
              echo "10%ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã§5åˆ†é–“ç›£è¦–ã—ã¾ã™..."
              sleep 300  # 5åˆ†å¾…æ©Ÿ
              
              # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
              API_URL=$(aws cloudformation describe-stacks \
                --stack-name "${STACK_PREFIX}-api" \
                --region "$AWS_REGION" \
                --query 'Stacks[0].Outputs[?OutputKey==`ApiGatewayUrl`].OutputValue' \
                --output text 2>/dev/null || echo "")
              
              if [[ -n "$API_URL" ]]; then
                echo "æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
                for i in {1..5}; do
                  if curl -f -s "${API_URL}/health" >/dev/null; then
                    echo "âœ… æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
                    break
                  else
                    echo "â³ æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•— (è©¦è¡Œ $i/5)"
                    if [ $i -eq 5 ]; then
                      echo "âŒ æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•— - ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™"
                      # å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™
                      aws lambda update-alias \
                        --function-name "${STACK_PREFIX}-api-function" \
                        --name "LIVE" \
                        --function-version "\$LATEST" \
                        --region "$AWS_REGION"
                      exit 1
                    else
                      sleep 30
                    fi
                  fi
                done
              fi
              
              # 100%ã«åˆ‡ã‚Šæ›¿ãˆ
              echo "100%ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã«åˆ‡ã‚Šæ›¿ãˆä¸­..."
              aws lambda update-alias \
                --function-name "${STACK_PREFIX}-api-function" \
                --name "LIVE" \
                --function-version "$NEW_VERSION" \
                --region "$AWS_REGION"
              
              echo "âœ… æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆ100%ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ï¼‰"
            else
              # ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ä½œæˆ
              aws lambda create-alias \
                --function-name "${STACK_PREFIX}-api-function" \
                --name "LIVE" \
                --function-version "$NEW_VERSION" \
                --region "$AWS_REGION"
            fi
          else
            echo "Lambdaé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’å…ˆã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„ã€‚"
          fi

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰
        if: needs.pre-deployment-check.outputs.rollback-mode == 'false'
        run: |
          echo "=== æœ¬ç•ªãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰é–‹å§‹ ==="
          cd frontend

          # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm ci --production=false

          # API Gateway URLã‚’å–å¾—
          API_URL=""
          if aws cloudformation describe-stacks --stack-name "${STACK_PREFIX}-api" --region "$AWS_REGION" >/dev/null 2>&1; then
            API_URL=$(aws cloudformation describe-stacks \
              --stack-name "${STACK_PREFIX}-api" \
              --region "$AWS_REGION" \
              --query 'Stacks[0].Outputs[?OutputKey==`ApiGatewayUrl`].OutputValue' \
              --output text 2>/dev/null || echo "")
          fi

          echo "API URL: $API_URL"

          # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
          cat > .env.production << EOF
          NEXT_PUBLIC_API_URL=${API_URL}
          NEXT_PUBLIC_ENVIRONMENT=${ENVIRONMENT}
          NEXT_PUBLIC_AWS_REGION=${AWS_REGION}
          EOF

          # Next.js ãƒ“ãƒ«ãƒ‰ï¼ˆæœ¬ç•ªæœ€é©åŒ–ï¼‰
          NODE_ENV=production npm run build
          cd ..

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
        if: needs.pre-deployment-check.outputs.rollback-mode == 'false'
        run: |
          echo "=== æœ¬ç•ªãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹ ==="

          # S3ãƒã‚±ãƒƒãƒˆåã‚’å–å¾—
          FRONTEND_BUCKET=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_PREFIX}-frontend" \
            --region "$AWS_REGION" \
            --query 'Stacks[0].Outputs[?OutputKey==`FrontendS3BucketName`].OutputValue' \
            --output text 2>/dev/null || echo "")

          if [[ -n "$FRONTEND_BUCKET" ]]; then
            echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ S3 ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­: $FRONTEND_BUCKET"
            
            # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆ
            BACKUP_BUCKET="${FRONTEND_BUCKET}-backup"
            if aws s3 ls "s3://$BACKUP_BUCKET" --region "$AWS_REGION" >/dev/null 2>&1; then
              echo "ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­..."
              aws s3 sync "s3://$FRONTEND_BUCKET" "s3://$BACKUP_BUCKET" --region "$AWS_REGION" --delete
            fi
            
            # ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            cd frontend
            aws s3 sync out/ "s3://$FRONTEND_BUCKET" \
              --region "$AWS_REGION" \
              --delete \
              --cache-control "public, max-age=31536000, immutable" \
              --exclude "*.html" \
              --exclude "*.json" \
              --exclude "service-worker.js"
            
            # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã¯çŸ­ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ™‚é–“ã§è¨­å®š
            aws s3 sync out/ "s3://$FRONTEND_BUCKET" \
              --region "$AWS_REGION" \
              --cache-control "public, max-age=300" \
              --include "*.html" \
              --include "*.json" \
              --include "service-worker.js"
            
            cd ..
            
            # CloudFrontã®ç„¡åŠ¹åŒ–
            CLOUDFRONT_DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
              --stack-name "${STACK_PREFIX}-frontend" \
              --region "$AWS_REGION" \
              --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionId`].OutputValue' \
              --output text 2>/dev/null || echo "")
            
            if [[ -n "$CLOUDFRONT_DISTRIBUTION_ID" && "$CLOUDFRONT_DISTRIBUTION_ID" != "None" ]]; then
              echo "CloudFrontã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ä¸­..."
              INVALIDATION_ID=$(aws cloudfront create-invalidation \
                --distribution-id "$CLOUDFRONT_DISTRIBUTION_ID" \
                --paths "/*" \
                --region "$AWS_REGION" \
                --query 'Invalidation.Id' \
                --output text)
              
              echo "CloudFrontç„¡åŠ¹åŒ–ID: $INVALIDATION_ID"
              
              # ç„¡åŠ¹åŒ–å®Œäº†ã‚’å¾…æ©Ÿ
              aws cloudfront wait invalidation-completed \
                --distribution-id "$CLOUDFRONT_DISTRIBUTION_ID" \
                --id "$INVALIDATION_ID" \
                --region "$AWS_REGION"
            fi
            
            echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
          else
            echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ S3 ãƒã‚±ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
            exit 1
          fi

      - name: æœ¬ç•ªç’°å¢ƒçµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        if: needs.pre-deployment-check.outputs.rollback-mode == 'false'
        run: |
          echo "=== æœ¬ç•ªç’°å¢ƒçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ ==="

          # API Gateway URLã‚’å–å¾—
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_PREFIX}-api" \
            --region "$AWS_REGION" \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiGatewayUrl`].OutputValue' \
            --output text 2>/dev/null || echo "")

          if [[ -n "$API_URL" && "$API_URL" != "å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" ]]; then
            echo "æœ¬ç•ªAPIçµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
            
            # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆå³æ ¼ï¼‰
            for i in {1..15}; do
              if curl -f -s "${API_URL}/health" >/dev/null; then
                echo "âœ… æœ¬ç•ªAPI ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
                break
              else
                echo "â³ æœ¬ç•ªAPI ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•— (è©¦è¡Œ $i/15)"
                if [ $i -eq 15 ]; then
                  echo "âŒ æœ¬ç•ªAPI ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸ"
                  exit 1
                else
                  sleep 20
                fi
              fi
            done
            
            # åŸºæœ¬çš„ãªAPIãƒ†ã‚¹ãƒˆ
            echo "åŸºæœ¬çš„ãªAPIãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
            
            # èªè¨¼ãªã—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ
            if curl -f -s "${API_URL}/health" | jq -e '.status == "healthy"' >/dev/null 2>&1; then
              echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯APIãƒ†ã‚¹ãƒˆæˆåŠŸ"
            elif curl -f -s "${API_URL}/health" | jq -e '.status' >/dev/null 2>&1; then
              echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª"
            else
              echo "âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯APIãƒ†ã‚¹ãƒˆå¤±æ•—"
              exit 1
            fi
          else
            echo "âŒ API URLãŒå–å¾—ã§ãã¾ã›ã‚“"
            exit 1
          fi

          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
          echo "--- æœ¬ç•ªç’°å¢ƒãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ ---"

          # CloudFront URLã‚’å–å¾—
          CLOUDFRONT_URL=$(aws cloudfront describe-stacks \
            --stack-name "${STACK_PREFIX}-frontend" \
            --region "$AWS_REGION" \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionDomainName`].OutputValue' \
            --output text 2>/dev/null || echo "")

          if [[ -n "$CLOUDFRONT_URL" && "$CLOUDFRONT_URL" != "å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" ]]; then
            echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
            
            # åŸºæœ¬çš„ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
            RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' "https://$CLOUDFRONT_URL")
            echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: ${RESPONSE_TIME}ç§’"
            
            # 2ç§’ä»¥å†…ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æœŸå¾…
            if (( $(echo "$RESPONSE_TIME < 2.0" | bc -l) )); then
              echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆæˆåŠŸ"
            else
              echo "âš ï¸ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé…ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            fi
          fi

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—
        id: deploy-info
        run: |
          echo "=== æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ± ==="

          # API Gateway URL
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_PREFIX}-api" \
            --region "$AWS_REGION" \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiGatewayUrl`].OutputValue' \
            --output text 2>/dev/null || echo "å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
          echo "API Gateway URL: $API_URL"
          echo "api-url=$API_URL" >> $GITHUB_OUTPUT

          # CloudFront URL
          CLOUDFRONT_URL=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_PREFIX}-frontend" \
            --region "$AWS_REGION" \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionDomainName`].OutputValue' \
            --output text 2>/dev/null || echo "å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
          echo "Frontend URL (CloudFront): https://$CLOUDFRONT_URL"
          echo "frontend-url=https://$CLOUDFRONT_URL" >> $GITHUB_OUTPUT

          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
          DB_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_PREFIX}-database" \
            --region "$AWS_REGION" \
            --query 'Stacks[0].Outputs[?OutputKey==`DatabaseClusterEndpoint`].OutputValue' \
            --output text 2>/dev/null || echo "å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
          echo "Database Endpoint: $DB_ENDPOINT"
          echo "database-endpoint=$DB_ENDPOINT" >> $GITHUB_OUTPUT

          # Lambdaé–¢æ•°ãƒãƒ¼ã‚¸ãƒ§ãƒ³
          LAMBDA_VERSION=$(aws lambda get-alias \
            --function-name "${STACK_PREFIX}-api-function" \
            --name "LIVE" \
            --region "$AWS_REGION" \
            --query 'FunctionVersion' \
            --output text 2>/dev/null || echo "å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
          echo "Lambda Function Version: $LAMBDA_VERSION"
          echo "lambda-version=$LAMBDA_VERSION" >> $GITHUB_OUTPUT

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Œäº†é€šçŸ¥
        run: |
          if [[ "${{ needs.pre-deployment-check.outputs.rollback-mode }}" == "true" ]]; then
            echo "ğŸ”„ æœ¬ç•ªç’°å¢ƒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          else
            echo "ğŸ‰ æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
            echo ""
            echo "ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ±:"
            echo "- ç’°å¢ƒ: $ENVIRONMENT"
            echo "- ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ github.event.inputs.version }}"
            echo "- API URL: ${{ steps.deploy-info.outputs.api-url }}"
            echo "- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ URL: ${{ steps.deploy-info.outputs.frontend-url }}"
            echo "- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: ${{ steps.deploy-info.outputs.database-endpoint }}"
            echo "- Lambda ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.deploy-info.outputs.lambda-version }}"
            echo ""
            echo "ğŸ”— æœ¬ç•ªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³: ${{ steps.deploy-info.outputs.frontend-url }}"
            echo ""
            echo "âœ… çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†"
            echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"
            echo "âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†"
            echo "ğŸ”„ ãƒ–ãƒ«ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
          fi
